<?php/** * 用户管理 * * 操作： *      login：登录 *      register：注册 *      logout：退出 * * 消息处理： *      checkLogin：登录验证 *      checkRegister：注册验证 * * @author xiaomo<i@nixiaomo.com> */namespace Admin\Controller;use Common\Controller\BaseController;class UserController extends BaseController{    /**     * 登录     */    public function login()    {        if ($this->checkLogged() || $this->initCookies()) {            $this->redirect('Index/index');        } else {            $this->display('User/login');        }    }    /**     * 消息处理——登录验证     */    public function checkLogin()    {        $data = I('post./a');        // 判断验证码        $ajaxData['status'] = 0;        if (!check_verify($data['code'])) {            $ajaxData['msg'] = '验证码错误';            $this->ajaxReturn($ajaxData, 'JSON');        }        // 检查用户名密码        $where['user'] = $data['user'];        $msg = M('user')->field('id,nickname,psw')->where($where)->find();        if (empty($msg)) {            $ajaxData['msg'] = '用户名不存在';        } else if ($msg['psw'] != auth_psw($data['psw'])) {            $ajaxData['msg'] = '密码不正确';        } else {    // 登录成功            // 保存cookie            $this->setCookies(array($data['user'], $msg['id'], $msg['nickname']));            $ajaxData['status'] = 1;            $ajaxData['msg'] = '登录成功';        }        $this->ajaxReturn($ajaxData, 'JSON');    }    /**     * 注册     */    public function register()    {        $this->show('注册功能暂不开放');//        $this->display();    }    /**     * 消息处理——注册验证     */    public function checkRegister()    {        $data = I('post./a');        // 判断验证码        $ajaxData['status'] = 0;        if (!check_verify($data['code'])) {            $ajaxData['msg'] = '验证码错误';            $this->ajaxReturn($ajaxData, 'JSON');        }        unset($data['code']);        // 检查用户名是否存在        $where['user'] = $data['user'];        $msg = M('user')->where($where)->find();        if (!empty($msg)) {            $ajaxData['msg'] = '用户名已存在';        } else {            // 注册，验证数据            $User = D('user');            $data['psw'] = auth_psw($data['psw']);            if (!$User->create($data)) {                $ajaxData['msg'] = $User->getError();   // 返回错误状态                $this->ajaxReturn($ajaxData, 'JSON');            }            // 插入数据库            $result = $User->add();            if ($result > 0) {                $ajaxData['status'] = 1;                $ajaxData['msg'] = '注册成功';            } else {                $ajaxData['msg'] = '注册失败';            }        }        $this->ajaxReturn($ajaxData, 'JSON');    }    /**     * 消息处理——获取验证码     */    public function getVerify()    {        $Verify = new \Think\Verify();        $Verify->length = 4;    // 长度        $Verify->useCurve = false;  // 去除混淆曲线        $Verify->entry();    }    /**     * 退出     */    public function logout()    {        cookie(null);        session(null);        $this->redirect('User/login');    }}