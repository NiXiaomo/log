<?php/** * Created by PhpStorm. * User: xiaomo * Date: 2016/8/27 * Time: 13:04 */namespace Home\Controller;use Think\Controller;class PostController extends Controller{    public function index()    {        if (!session('user')) exit('{"err": 0, "message": "请先登录再进行后续操作"}');        $m = M('post');        // 获取各分类数量        // SELECT `status`, COUNT(`status`) AS `total` FROM `log_post` GROUP BY `status`        $where_count['user'] = session('user');        $counts = $m->field('status,count(status) as total')->group('status')->where($where_count)->select();        $sum = 0;   // 记录总量        $trashFlag = false; // 回收站不计入总量        foreach ($counts as $count) {            if ($count['status'] == 3) {                $trashFlag = true;                continue;            }            $sum += intval($count['total']);        }        $this->assign("sum", $sum);        if ($sum > 0 || $trashFlag) {            $this->assign("counts", $counts);            // 判断状态            if (!isset($_GET['post_status'])) $where['status'] = array('neq', 3);            switch ($_GET['post_status']) {                case "publish":                    $where['status'] = 1;                    break;                case "draft":                    $where['status'] = 2;                    break;                case "trash":                    $where['status'] = 3;                    break;            }            // 获取日志列表            $where['log_post.user'] = session('user');            $page = getPage($m, $where, 10); // 分页            $data = $m->field('id,title,post_date,status,count(log_comment.post_id) as total')                ->join('LEFT JOIN log_comment ON log_post.id = log_comment.post_id')->group('log_post.id')                ->order('post_date desc, id asc')->where($where)->limit($page->firstRow . ',' . $page->listRows)->select();            $this->assign("logs", $data);            $this->assign('page', $page->show());   // 赋值分页输出        }        $this->display('index');    }    /*     * 新建模块     */    public function add()    {        if (!session('user')) exit('{"err": 0, "message": "请先登录再进行后续操作"}');        $this->display('add');    }    /*     * 处理新建/编辑     */    public function post()    {        if (!session('user')) exit('{"err": 0, "message": "请先登录再进行后续操作"}');        $post_date = date("Y-m-d H:i:s");        $id = intval($_POST['p']);        $data['title'] = $_POST['title'];        $data['content'] = $_POST['content'];        $data['status'] = $_POST['status'];        $data['edit_date'] = $post_date;        $m = M("post");        if ($id == 0) { // 新增            $data['user'] = session('user');            $data['post_date'] = $post_date;            $result = $m->add($data);            $insertId = $m->getLastInsID(); // 获取insert id        } else {    // 编辑            $where['id'] = $id;            $where['user'] = session('user');            $result = $m->where($where)->save($data);            $insertId = $id;        }        // 更新缓存文件        setArchiveCache(session('user'));        // 响应        if ($result > 0) echo '{"err": 1, "id": "' . $insertId . '"}';        else echo '{"err": 0, "message": "操作失败！"}';    }    /*     * 处理垃圾箱     */    public function trash()    {        if (!session('user')) exit('请先登录再进行后续操作');        if (isset($_GET['action']) && isset($_GET['p']) && is_numeric($_GET['p'])) {            $action = $_GET['action'];            $m = M("post");            if ($action == "trash" || $action == "untrash") {   // 移入/移出垃圾箱                $where['id'] = intval($_GET['p']);                $where['user'] = session('user');                $action == "trash" ? $data['status'] = 3 : $data['status'] = 2;                $m->where($where)->save($data);            } else if ($action == "delete") {                $id = intval($_GET['p']);                $user = session('user');                // 需要同时删除评论                $sql = "DELETE p, c FROM `log_post` p LEFT JOIN `log_comment` c ON p.`id` = c.`post_id` WHERE p.`id` = $id AND p.`user` = '$user'";                $m->execute($sql);            }        }        // 更新缓存文件        setArchiveCache(session('user'));        $this->redirect('Post/index');    }    /*     * 编辑界面     */    public function edit()    {        if (!session('user')) exit('{"err": 0, "message": "请先登录再进行后续操作"}');        if (!isset($_GET['id']) || !is_numeric($_GET['id'])) $this->redirect("Index/index");        else {            $id = intval($_GET['id']);            $where['id'] = array('eq', $id);            $where['user'] = array('eq', session('user'));            $where['status'] = array('neq', 3);            $msg = M('post')->where($where)->find();            if (empty($msg)) exit("日志不存在或已被删除！");            $this->assign("id", $id);            $this->assign("title", $msg['title']);            $this->assign("content", $msg['content']);            $this->assign("edit_date", $msg['edit_date']);            $this->assign("status", intval($msg['status']));            $this->display('add');        }    }    /*     * 上传文件     */    public function upload()    {        $path = "./Public/files/";        $filename = uniqid() . $_POST['ext'];   // 文件名        $result = $this->fileUpload($_FILES['file'], $path, $filename);        if ($result != "success") exit($result);        echo "/log/Public/files/$filename";    }    /**     * 获取上传文件并保存     * @param array $fileArray $_FILES['file']     * @param string $path 文件保存路径     * @param string $filename 文件名     * @return string     */    function fileUpload($fileArray, $path, $filename)    {        if ($fileArray["error"] > 0) {            return "上传失败，请重试";        }        $tmp = $fileArray['tmp_name'];        if (!file_exists($path)) {            mkdir($path, 0777, true);        }        if (!move_uploaded_file($tmp, $path . $filename)) {            return "文件保存失败";        }        return "success";    }}