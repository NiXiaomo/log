<?php/** * 用户管理 * * 操作： *      login：登录 *      register：注册 *      logout：退出 * * 消息处理： *      check_login：登录验证 *      check_register：注册验证 * * @author xiaomo<xiaomo@nixiaomo.com> */namespace Home\Controller;class UserController extends BaseController{    /**     * 登录     */    public function login()    {        // 从cookie中读取用户名        if (cookie('login')) {            session("user", explode('|', cookie('login'))[0]);            $this->redirect('Index/index');        } else $this->display();    }    /**     * 消息处理——登录验证     */    public function check_login()    {        $user = I('post.user');        $psw = I('post.psw');        $remember = I('post.remember');        // 参数验证        $ajaxData['status'] = 0;        if (empty($user) || empty($psw) || empty($remember)) {            $ajaxData['info'] = '参数有误';            $this->ajaxReturn($ajaxData, 'JSON');        }        // 检查用户名密码        $where['user'] = array('eq', "$user");        $msg = M('user')->where($where)->find();        if (empty($msg)) {            $ajaxData['info'] = '用户名不存在';        } else if ($msg['psw'] != $psw) {            $ajaxData['info'] = '密码不正确';        } else {    // 登录成功            // 保存cookie            if ($_POST['remember'] == "true") {                cookie('login', $user . '|' . $psw);            }            session("user", $user);            // 登录成功跳转url            $redirectUrl = U('Index/index');            if (session('redirect_to')) {                $redirectUrl = session('redirect_to');                session('redirect_to', null);            }            $ajaxData['status'] = 1;            $ajaxData['redirect_to'] = $redirectUrl;        }        $this->ajaxReturn($ajaxData, 'JSON');    }    /**     * 注册     */    public function register()    {        $this->display();    }    /**     * 消息处理——注册验证     */    public function check_register()    {        $user = I('post.user');        $psw = I('post.psw');        // 参数验证        $ajaxData['status'] = 0;        if (empty($user) || empty($psw)) {            $ajaxData['info'] = '参数有误';            $this->ajaxReturn($ajaxData, 'JSON');        }        // 检查用户名是否存在        $where['user'] = array('eq', "$user");        $msg = M('user')->where($where)->find();        if (!empty($msg)) {            $ajaxData['info'] = '用户名已存在';        } else {            // 注册            $data['user'] = $user;            $data['psw'] = $psw;            $result = M("user")->add($data);            if ($result > 0) {                $ajaxData['status'] = 1;                $ajaxData['info'] = '注册成功';            } else {                $ajaxData['info'] = '注册失败';            }        }        $this->ajaxReturn($ajaxData, 'JSON');    }    /**     * 退出     */    public function logout()    {        cookie(null);        session(null);        $this->redirect('User/login');    }}