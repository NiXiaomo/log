<extend name="Public:base"/>
<block name="title">
    <empty name="title">
        编辑
        <else/>
        新建
    </empty>
</block>
<block name="css">
    <!-- Summernote CSS-->
    <link href="__PUBLIC__/css/summernote.css" rel="stylesheet" type="text/css">
</block>

<block name="main">
    <div id="page-wrapper">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">
                    <if condition="$title">编辑日志
                        <else/>
                        撰写新日志
                    </if>
                </h1>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
        <div class="row">
            <div class="col-md-8">
                <form role="form">
                    <div class="form-group">
                        <input class="form-control input-title" placeholder="在此输入标题"
                               value="{$title|default=''}" autofocus>
                    </div>
                    <div class="form-group">
                        <div id="summernote">{$content|default=''}</div>
                    </div>
                </form>
            </div>
            <!-- /.col-md-8 -->
            <div class="col-md-4">
                <div class="panel panel-default">
                    <div class="panel-heading">发布</div>
                    <div class="panel-body">
                        <div class="form-group" style="min-height: 34px;">
                            <a class="btn btn-default btn-draft">保存为草稿</a>
                            <if condition="$status eq 1">
                                <a href="__ROOT__/p/{$id}" class="btn btn-default"
                                   style="float:right;" target="_blank">查看</a>
                            </if>
                        </div>
                        <div class="form-group">
                            <span class="fa fa-thumb-tack fa-fw"></span>当前状态：
                            <strong>
                                <if condition="$status eq 1">已发布
                                    <else/>
                                    草稿
                                </if>
                            </strong>
                        </div>
                        <div class="form-group">
                            <span class="fa fa-calendar fa-fw"></span>上次编辑：
                            <strong>{$edit_date|default='待发布'}</strong>
                        </div>
                    </div>
                    <div class="panel-footer" style="min-height: 55px">
                        <if condition="$status neq 0">
                            <a class="btn btn-link" href="{:U('Post/trash')}?p={$id}&action=trash">移至回收站</a>
                        </if>
                        <button class="btn btn-primary btn-post" style="float: right;">
                            <if condition="$status eq 1">更新
                                <else/>
                                发布
                            </if>
                        </button>
                    </div>
                </div>
            </div>
            <!-- /.col-md-4 -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /#page-wrapper -->
</block>

<block name="model"></block>

<block name="script">
    <!-- Summernote JavaScript -->
    <script src="__PUBLIC__/js/summernote.min.js"></script>

    <!-- Summernote lang zh-CN JavaScript -->
    <script src="__PUBLIC__/js/summernote-zh-CN.js"></script>

    <!-- Page-Level Demo Scripts - Tables - Use for reference -->
    <script type="text/javascript">
        $(document).ready(function () {
            $('#summernote').summernote({
                height: 300,
                minHeight: 300,
                maxHeight: 300,
                lang: 'zh-CN',
                toolbar: [
                    ['color', ['color']],
                    ['font', ['style']],
                    ['fontsize', ['fontsize']],
                    ['style', ['bold', 'italic', 'underline', 'clear', 'strikethrough']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    ['insert', ['link', 'picture']]
                ],
                onImageUpload: function (files, editor, $editable) {
                    sendFile(files[0], editor, $editable);
                }
            });


            // 发布
            $(".btn-post").click(function () {
                release(1);
            });

            // 保存草稿
            $(".btn-draft").click(function () {
                release(2);
            });


            /**
             * 发布
             * @param status
             */
            function release(status) {
                var title = $(".input-title").val();
                var content = $('#summernote').code();
                var p = '{$id|default=0}';
                if ($.trim(title) == "" || content == "" || content == "<br>" || content == "<p><br></p>") {
                    showTips("标题和内容不能为空");
                    return;
                }

                $("#loadDiv").show();
                $.ajax({
                    url: "{:U('Post/post')}",
                    type: 'post',
                    data: {
                        p: p,
                        title: title,
                        content: content,
                        status: status
                    },
                    success: function (data) {
                        if (data.status > 0) {
                            window.location.href = data.info;
                        } else {
                            showTips(data.info);
                            $("#loadDiv").hide();
                        }
                    }
                });
            }


            function sendFile(file, editor, $editable) {
                $("#tipsDiv").show().children(".warn").html("图片正在上传，请稍候...");

                var filename = file['name'];
                // 以上防止在图片在编辑器内拖拽引发第二次上传导致的提示错误
                var ext = filename.substr(filename.lastIndexOf(".")).toLowerCase();
                data = new FormData();
                data.append("file", file);
                data.append("ext", ext);
                $.ajax({
                    data: data,
                    type: "post",
                    url: "{:U('Post/upload')}",
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data.status > 0) {
                            showTips("上传成功,请等待加载");
                            editor.insertImage($editable, "__PUBLIC__/files/" + data.info);
                        } else {
                            showTips(data.info);
                        }

                        if (!window.addEventListener)
                            $("input[type='file']").outerHTML("");  //IE清除inputfile
                        else
                            $("input[type='file']").val("");   //FF清除inputfile
                    },
                    error: function () {
                        showTips("上传失败");
                    }
                });
            }
        });
    </script>
</block>
